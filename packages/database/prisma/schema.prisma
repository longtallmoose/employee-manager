// packages/database/prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  output        = "../../backend/node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum UserRole {
  EMPLOYEE
  LINE_MANAGER
  DEPT_MANAGER
  HR_ADVISOR
  PAYROLL_OFFICER
  SCHEDULER
  COMPLIANCE_OFFICER
  SUPER_ADMIN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  ZERO_HOURS
  CONTRACTOR
  FREELANCE
  APPRENTICE
}

enum PayBasis {
  SALARIED
  HOURLY
  DAY_RATE
}

enum LeaveType {
  ANNUAL_LEAVE
  SICKNESS_SELF_CERT
  SICKNESS_DOCTOR_CERT
  TOIL
  UNPAID
  MATERNITY
  PATERNITY
  ADOPTION
  BEREAVEMENT
  JURY_SERVICE
  TRAINING
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REQUIRES_INFO
}

enum RightToWorkStatus {
  BRITISH_CITIZEN
  SETTLED_STATUS
  VISA_TIER_2
  VISA_STUDENT
  VISA_SPOUSAL
  PENDING_CHECK
}

enum CaseType {
  DISCIPLINARY
  GRIEVANCE
  CAPABILITY_PERFORMANCE
  SAFEGUARDING
  WHISTLEBLOWING
}

enum CaseStage {
  INTAKE
  INVESTIGATION
  HEARING
  OUTCOME
  APPEAL
  CLOSED
}

enum DocumentCategory {
  CONTRACT
  ID_PROOF
  PAYSLIP
  POLICY_ACK
  CERTIFICATION
  MEDICAL_NOTE
  CASE_EVIDENCE
}

// --------------------------------------
// CORE MODELS
// --------------------------------------

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String
  role                UserRole  @default(EMPLOYEE)
  mfaEnabled          Boolean   @default(false)
  mfaSecret           String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
   
  employee       Employee?
  auditLogs      AuditLog[] 
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Employee {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
   
  firstName       String
  lastName        String
  preferredName   String?
  dateOfBirth     DateTime?
  niNumber        String?   
  
  // Compliance
  rightToWorkStatus RightToWorkStatus @default(PENDING_CHECK)
   
  // Contact Info
  phoneNumber     String?   // Personal Mobile
  addressLine1    String?
  addressLine2    String?
  city            String?
  region          String?   // County/State
  postcode        String?
  country         String    @default("UK")
   
  // Emergency Contact
  emergencyName   String?
  emergencyRel    String?   // Relationship
  emergencyPhone  String?

  avatarUrl       String?
  isActive        Boolean   @default(true)
   
  records         EmploymentRecord[]
  documents       Document[]
  leaveRequests   LeaveRequest[]
  shifts          Shift[]
  casesInvolved   CaseInvolvedParty[]
  training        EmployeeTraining[]
  bankDetails     BankDetails?
   
  managerId       String?
  manager         Employee?  @relation("DirectReports", fields: [managerId], references: [id])
  directReports   Employee[] @relation("DirectReports")

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model EmploymentRecord {
  id              String         @id @default(uuid())
  employeeId      String
  employee        Employee       @relation(fields: [employeeId], references: [id])
   
  startDate       DateTime
  endDate         DateTime?       
   
  jobTitle        String
  department      String
  location        String         
   
  employmentType  EmploymentType @default(FULL_TIME)
  payBasis        PayBasis       @default(SALARIED)
  payAmount       Decimal        @db.Decimal(12, 2)
  currency        String         @default("GBP")
   
  hoursPerWeek    Decimal        @db.Decimal(4, 2) @default(37.5)
   
  contractUrl     String?
  changeReason    String?        
  changedBy       String?        
   
  createdAt       DateTime       @default(now())
}

model BankDetails {
  id              String    @id @default(uuid())
  employeeId      String    @unique
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  accountName     String
  sortCode        String    
  accountNumber   String    
  bankName        String?
   
  updatedAt       DateTime  @updatedAt
}

model LeaveRequest {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  type            LeaveType
  startDate       DateTime
  endDate         DateTime
  isHalfDay       Boolean   @default(false)
  totalDays       Decimal   @db.Decimal(4, 1)
  status          ApprovalStatus @default(PENDING)
  managerNote     String?
  rejectionReason String?
  approvedById    String?
  approvedAt      DateTime?
  documentId      String?
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Shift {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  startTime       DateTime
  endTime         DateTime
  breakMinutes    Int       @default(0)
  locationId      String
  roleRequired    String?   
  isPublished     Boolean   @default(false)
  isOpenShift     Boolean   @default(false) 
  actualStart     DateTime? 
  actualEnd       DateTime?
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model HRCase {
  id              String    @id @default(uuid())
  reference       String    @unique 
  type            CaseType
  summary         String
  detailedDesc    String    @db.Text
  status          CaseStage
  riskLevel       String    
  openedAt        DateTime  @default(now())
  closedAt        DateTime?
  leadHrUserId    String    
  involvedParties CaseInvolvedParty[]
  timeline        CaseTimelineEvent[]
  evidence        Document[]
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CaseInvolvedParty {
  id              String    @id @default(uuid())
  caseId          String
  case            HRCase    @relation(fields: [caseId], references: [id])
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  role            String    
}

model CaseTimelineEvent {
  id              String    @id @default(uuid())
  caseId          String
  case            HRCase    @relation(fields: [caseId], references: [id])
  stage           CaseStage
  title           String
  description     String?
  occurredAt      DateTime
  loggedByUserId  String
}

model Document {
  id              String    @id @default(uuid())
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])
  caseId          String?
  case            HRCase?   @relation(fields: [caseId], references: [id])
  title           String
  category        DocumentCategory
  storageUrl      String    
  mimeType        String
  sizeBytes       Int
  uploadedBy      String
  expiryDate      DateTime? 
  createdAt       DateTime  @default(now())
}

model EmployeeTraining {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  name            String
  provider        String?
  completedAt     DateTime
  expiresAt       DateTime?
  certificateUrl  String?
  createdAt       DateTime  @default(now())
}

model AuditLog {
  id              String    @id @default(uuid())
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
  action          String    
  entityType      String    
  entityId        String
  oldValue        Json?     
  newValue        Json?     
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime  @default(now())
}