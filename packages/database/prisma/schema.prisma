// This is the COMPLETE production schema.

// Generator
generator client {
  provider      = "prisma-client-js"
  // Supports Mac (native) and Render Cloud (debian-openssl)
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// Datasource (ONLY ONE ALLOWED)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// ENUMS (UK Context & System)
// --------------------------------------

enum UserRole {
  EMPLOYEE
  LINE_MANAGER
  DEPT_MANAGER
  HR_ADVISOR
  PAYROLL_OFFICER
  SCHEDULER
  COMPLIANCE_OFFICER
  SUPER_ADMIN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  ZERO_HOURS
  CONTRACTOR
  FREELANCE
  APPRENTICE
}

enum PayBasis {
  SALARIED
  HOURLY
  DAY_RATE
}

enum LeaveType {
  ANNUAL_LEAVE
  SICKNESS_SELF_CERT
  SICKNESS_DOCTOR_CERT
  TOIL
  UNPAID
  MATERNITY
  PATERNITY
  ADOPTION
  BEREAVEMENT
  JURY_SERVICE
  TRAINING
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REQUIRES_INFO
}

enum RightToWorkStatus {
  BRITISH_CITIZEN
  SETTLED_STATUS
  VISA_TIER_2
  VISA_STUDENT
  VISA_SPOUSAL
  PENDING_CHECK
}

enum CaseType {
  DISCIPLINARY
  GRIEVANCE
  CAPABILITY_PERFORMANCE
  SAFEGUARDING
  WHISTLEBLOWING
}

enum CaseStage {
  INTAKE
  INVESTIGATION
  HEARING
  OUTCOME
  APPEAL
  CLOSED
}

enum DocumentCategory {
  CONTRACT
  ID_PROOF
  PAYSLIP
  POLICY_ACK
  CERTIFICATION
  MEDICAL_NOTE
  CASE_EVIDENCE
}

// --------------------------------------
// CORE IDENTITY & ACCESS
// --------------------------------------

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    // BCrypt
  mfaEnabled          Boolean   @default(false)
  mfaSecret           String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
   
  // Relations
  employee       Employee?
  auditLogs      AuditLog[] // Actions performed by this user
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Employee {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
   
  // Personal Details (GDPR Sensitive)
  firstName       String
  lastName        String
  preferredName   String?
  dateOfBirth     DateTime
  niNumber        String?   // Encrypted in app logic, stored string here
   
  // Contact
  phoneNumber     String?
  addressLine1    String
  addressLine2    String?
  city            String
  postcode        String
  country         String    @default("UK")
   
  // Emergency Contact
  emergencyName   String?
  emergencyRel    String?
  emergencyPhone  String?

  // System Metadata
  avatarUrl       String?
  isActive        Boolean   @default(true)
   
  // Relations - The "Why" behind the "What"
  records         EmploymentRecord[]
  documents       Document[]
  leaveRequests   LeaveRequest[]
  shifts          Shift[]
  casesInvolved   CaseInvolvedParty[]
  training        EmployeeTraining[]
  bankDetails     BankDetails?
   
  managerId       String?
  manager         Employee?  @relation("DirectReports", fields: [managerId], references: [id])
  directReports   Employee[] @relation("DirectReports")

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// --------------------------------------
// OPERATIONAL CORE (The Source of Truth)
// --------------------------------------

// Versioned history of an employee's role/pay
model EmploymentRecord {
  id              String         @id @default(uuid())
  employeeId      String
  employee        Employee       @relation(fields: [employeeId], references: [id])
   
  startDate       DateTime
  endDate         DateTime?      // Null means current
   
  jobTitle        String
  department      String
  location        String         // Office ID or Name
   
  employmentType  EmploymentType
  payBasis        PayBasis
  payAmount       Decimal        @db.Decimal(10, 2) // Hourly rate or Annual Salary
  currency        String         @default("GBP")
   
  hoursPerWeek    Decimal        @db.Decimal(4, 2)
   
  contractUrl     String?
   
  // Audit
  changeReason    String?        // e.g. "Annual Promotion", "Role Change"
  changedBy       String         // Admin ID
   
  createdAt       DateTime       @default(now())
}

model BankDetails {
  id              String    @id @default(uuid())
  employeeId      String    @unique
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  accountName     String
  sortCode        String    // Stored with simple masking logic in API
  accountNumber   String    // Stored with simple masking logic in API
  bankName        String?
   
  updatedAt       DateTime  @updatedAt
}

// --------------------------------------
// TIME, ATTENDANCE & LEAVE
// --------------------------------------

model LeaveRequest {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  type            LeaveType
  startDate       DateTime
  endDate         DateTime
  isHalfDay       Boolean   @default(false)
   
  totalDays       Decimal   @db.Decimal(4, 1)
   
  status          ApprovalStatus @default(PENDING)
   
  managerNote     String?
  rejectionReason String?
   
  approvedById    String?
  approvedAt      DateTime?
   
  // Link to fit note if sickness
  documentId      String?
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Shift {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  startTime       DateTime
  endTime         DateTime
  breakMinutes    Int       @default(0)
   
  locationId      String
  roleRequired    String?   // Skill based routing
   
  isPublished     Boolean   @default(false)
  isOpenShift     Boolean   @default(false) // Can anyone claim it?
   
  actualStart     DateTime? // For time tracking
  actualEnd       DateTime?
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// --------------------------------------
// HR CASE MANAGEMENT (UK COMPLIANCE)
// --------------------------------------

model HRCase {
  id              String    @id @default(uuid())
  reference       String    @unique // Readable ID e.g., CASE-2023-001
  type            CaseType
   
  summary         String
  detailedDesc    String    @db.Text
   
  status          CaseStage
  riskLevel       String    // Low, Medium, High, Critical
   
  openedAt        DateTime  @default(now())
  closedAt        DateTime?
   
  leadHrUserId    String    // The HR advisor managing this
   
  involvedParties CaseInvolvedParty[]
  timeline        CaseTimelineEvent[]
  evidence        Document[]
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CaseInvolvedParty {
  id              String    @id @default(uuid())
  caseId          String
  case            HRCase    @relation(fields: [caseId], references: [id])
   
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  role            String    // Subject, Witness, Complainant, Note Taker
}

model CaseTimelineEvent {
  id              String    @id @default(uuid())
  caseId          String
  case            HRCase    @relation(fields: [caseId], references: [id])
   
  stage           CaseStage
  title           String
  description     String?
  occurredAt      DateTime
   
  loggedByUserId  String
}

// --------------------------------------
// DOCUMENTS & COMPLIANCE
// --------------------------------------

model Document {
  id              String    @id @default(uuid())
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])
   
  caseId          String?
  case            HRCase?   @relation(fields: [caseId], references: [id])
   
  title           String
  category        DocumentCategory
  storageUrl      String    // S3 path
  mimeType        String
  sizeBytes       Int
   
  uploadedBy      String
   
  expiryDate      DateTime? // Essential for Right to Work / Certs
   
  createdAt       DateTime  @default(now())
}

model EmployeeTraining {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
   
  name            String
  provider        String?
  completedAt     DateTime
  expiresAt       DateTime?
   
  certificateUrl  String?
   
  createdAt       DateTime  @default(now())
}

// --------------------------------------
// SYSTEM AUDIT (IMMUTABLE LOGS)
// --------------------------------------

model AuditLog {
  id              String    @id @default(uuid())
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
   
  action          String    // CREATE, UPDATE, DELETE, VIEW_SENSITIVE
  entityType      String    // Employee, BankDetails, Case
  entityId        String
   
  oldValue        Json?     // JSON snapshot of before state
  newValue        Json?     // JSON snapshot of after state
   
  ipAddress       String?
  userAgent       String?
   
  timestamp       DateTime  @default(now())
}